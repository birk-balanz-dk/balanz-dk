<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balanz.dk - Smart Madplanl√¶gger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'balanz-green': '#7B9B7D',
                        'balanz-blue': '#A8C4D0', 
                        'balanz-beige': '#f9f2e8'
                    }
                }
            }
        }
    </script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans bg-balanz-beige min-h-screen">
    <!-- Navigation -->
    <nav class="shadow-sm bg-balanz-beige">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/">
                <img src="/images/header-logo.png" alt="Balanz.dk" class="h-10 w-auto">
            </a>
            <div class="flex gap-4">
                <a href="/deals.html" class="bg-balanz-blue text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-opacity-90 transition-all">
                    Se Alle Tilbud
                </a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="max-w-6xl mx-auto px-4 py-16">
        <div class="grid lg:grid-cols-2 gap-12 items-center">
            <div class="order-2 lg:order-1">
                <img src="/images/planner.png" alt="Plan your meals together" class="aspect-square max-w-md mx-auto rounded-3xl shadow-lg">
            </div>
            
            <div class="order-1 lg:order-2 text-center lg:text-left">
                <h1 class="text-4xl lg:text-5xl font-bold text-gray-800 mb-6 leading-tight">
                    SMART<br>
                    <span class="text-balanz-green">MADPLAN</span>
                </h1>
                <h1 class="text-4xl lg:text-5xl font-bold text-gray-800 mb-6 leading-tight">
                    SPARET<br>
                    <span class="text-balanz-green">PENGE</span>
                </h1>
                
                <p class="text-xl text-gray-600 mb-8 max-w-lg">
                    MAD & √òKONOMI I BALANCE
                </p>
            </div>
        </div>
    </section>

    <div class="max-w-6xl mx-auto px-4 pb-8">
        <!-- Section Header -->
        <div class="text-center mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">
                Intelligent <span class="text-balanz-green">planl√¶gning</span> starter her
            </h2>
            <p class="text-gray-600">Over 100 opskrifter tilpasset til aktuelle tilbud og dit budget</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6 sticky top-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Dine pr√¶ferencer</h3>
                    
                    <form id="mealPlanForm" class="space-y-6">
                        <!-- Family Size -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Antal personer</label>
                            <select id="familySize" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-balanz-green focus:border-transparent">
                                <option value="1">1 person</option>
                                <option value="2" selected>2 personer</option>
                                <option value="4">Familie (4 personer)</option>
                                <option value="6">Stor familie (6+ personer)</option>
                            </select>
                        </div>

                        <!-- Budget -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ugebudget</label>
                            <div class="relative">
                                <input type="range" id="budgetRange" min="300" max="1500" value="750" step="50" 
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>300 kr</span>
                                    <span>1500 kr</span>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <span id="budgetDisplay" class="text-lg font-bold text-balanz-green">750 kr</span>
                            </div>
                        </div>

                        <!-- Days -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Antal dage</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button type="button" class="day-btn p-2 border border-gray-300 rounded-lg text-center hover:bg-balanz-green hover:text-white transition-colors" data-days="3">3 dage</button>
                                <button type="button" class="day-btn p-2 border border-gray-300 rounded-lg text-center hover:bg-balanz-green hover:text-white transition-colors bg-balanz-green text-white" data-days="5">5 dage</button>
                                <button type="button" class="day-btn p-2 border border-gray-300 rounded-lg text-center hover:bg-balanz-green hover:text-white transition-colors" data-days="7">7 dage</button>
                            </div>
                        </div>

                        <!-- Generate Button -->
                        <button type="submit" id="generateBtn" 
                                class="w-full bg-balanz-green text-white font-bold py-4 px-6 rounded-lg text-lg hover:bg-opacity-90 transition-all duration-200">
                            <span id="buttonText">Start Planl√¶gning</span>
                            <div id="loadingSpinner" class="loading w-5 h-5 border-2 border-white border-t-transparent rounded-full mx-auto hidden"></div>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2">
                <div id="resultsContainer" class="hidden"></div>

                <!-- Placeholder -->
                <div id="placeholder" class="text-center py-16">
                    <div class="w-24 h-24 bg-balanz-green bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-4xl">üçΩÔ∏è</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Klar til at komme i gang?</h3>
                    <p class="text-gray-600">Udfyld pr√¶ferencerne til venstre.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12 mt-16">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="mb-4">
                ¬© 2025 Balanz.dk - Den smartere m√•de at handle ind
            </div>
            <div class="mb-4">
                <a href="#" class="text-gray-300 hover:text-balanz-green transition-colors mx-4">Privatlivspolitik</a>
                <span class="text-gray-500">|</span>
                <a href="#" class="text-gray-300 hover:text-balanz-green transition-colors mx-4">Vilk√•r og betingelser</a>
                <span class="text-gray-500">|</span>
                <a href="#" class="text-gray-300 hover:text-balanz-green transition-colors mx-4">Kontakt</a>
            </div>
            <div class="text-gray-400">
                Lavet med ‚ù§Ô∏è i Danmark
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let selectedDays = 5;
        let currentMealPlanData = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Planner initialized');
            setupBudgetSlider();
            setupDayButtons();
            setupForm();
        });

        function setupBudgetSlider() {
            const budgetRange = document.getElementById('budgetRange');
            const budgetDisplay = document.getElementById('budgetDisplay');
            
            budgetRange.addEventListener('input', function() {
                budgetDisplay.textContent = this.value + ' kr';
            });
        }

        function setupDayButtons() {
            const dayButtons = document.querySelectorAll('.day-btn');
            
            dayButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active state from all buttons
                    dayButtons.forEach(b => {
                        b.classList.remove('bg-balanz-green', 'text-white');
                        b.classList.add('border-gray-300');
                    });
                    
                    // Add active state to clicked button
                    this.classList.add('bg-balanz-green', 'text-white');
                    this.classList.remove('border-gray-300');
                    
                    selectedDays = parseInt(this.dataset.days);
                    console.log('üìÖ Selected days:', selectedDays);
                });
            });
        }

        function setupForm() {
            const form = document.getElementById('mealPlanForm');
            form.addEventListener('submit', handleFormSubmit);
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            console.log('üìù Form submitted');
            
            const formData = {
                familySize: parseInt(document.getElementById('familySize').value),
                budget: parseInt(document.getElementById('budgetRange').value),
                days: selectedDays
            };
            
            console.log('üìä Request data:', formData);
            await generateMealPlan(formData);
        }

        async function generateMealPlan(formData) {
            const generateBtn = document.getElementById('generateBtn');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // Show loading state
            generateBtn.disabled = true;
            buttonText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            try {
                console.log('üîÑ Sending request to API...');
                
                const response = await fetch('/api/generate-meal-plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                console.log('üì° Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', errorText);
                    throw new Error(`API fejl: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ API Success:', result);

                if (result.success && result.mealPlan) {
                    displayMealPlan(result);
                } else {
                    throw new Error(result.error || 'Ukendt fejl');
                }

            } catch (error) {
                console.error('üí• Error:', error);
                alert('Der opstod en fejl ved generering af madplan. Pr√∏v venligst igen.\n\nFejl: ' + error.message);
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        function displayMealPlan(data) {
            console.log('üé® Displaying meal plan:', data);
            currentMealPlanData = data;
            
            const resultsContainer = document.getElementById('resultsContainer');
            const placeholder = document.getElementById('placeholder');
            
            // Calculate display values
            const totalCost = Math.round(data.totalCost || 0);
            const savings = Math.round(data.savings || 0);
            const dealPercentage = Math.round((data.totalDealMatches / data.totalIngredients) * 100) || 0;
            
            const html = `
                <!-- Summary Card -->
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-3xl font-bold text-balanz-green">${totalCost} kr</div>
                            <div class="text-sm text-gray-600">Total pris</div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-balanz-blue">${dealPercentage}%</div>
                            <div class="text-sm text-gray-600">P√• tilbud</div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-gray-800">${data.mealPlan.length}</div>
                            <div class="text-sm text-gray-600">Retter</div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold ${savings >= 0 ? 'text-green-600' : 'text-red-600'}">${savings} kr</div>
                            <div class="text-sm text-gray-600">Besparelse</div>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <p class="text-gray-700">${data.summary || 'Smart madplan genereret!'}</p>
                    </div>
                </div>

                <!-- Meal Plan -->
                <div class="space-y-4">
                    ${data.mealPlan.map(meal => `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div class="p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">Dag ${meal.day}: ${meal.recipe}</h3>
                                        <div class="flex items-center space-x-4 mt-1 text-sm text-gray-600">
                                            <span>üë• ${meal.servings} pers</span>
                                            <span>üí∞ ${Math.round(meal.cost)} kr</span>
                                            <span>üéØ ${meal.dealMatches} tilbud</span>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-2">üõí Ingredienser:</h4>
                                    <ul class="space-y-1">
                                        ${meal.ingredients.map(ing => `
                                            <li class="flex justify-between text-sm">
                                                <span class="flex items-center">
                                                    ${ing.onSale ? '‚úÖ' : '‚ö´'} ${ing.item}
                                                    ${ing.store && ing.store !== 'Almindelig' ? `<span class="text-xs text-gray-500 ml-2">(${ing.store})</span>` : ''}
                                                </span>
                                                <span class="font-semibold">
                                                    ${ing.onSale ? `${Math.round(ing.price)} kr` : `~${Math.round(ing.price)} kr`}
                                                </span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>

                                ${meal.stealthUpgrade ? `
                                    <div class="mt-4 p-3 bg-green-50 rounded-lg">
                                        <h5 class="font-semibold text-green-800 text-sm mb-1">üí° Smart lille trick:</h5>
                                        <p class="text-green-700 text-sm">${meal.stealthUpgrade}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Shopping List -->
                ${generateShoppingListHTML(data.shoppingList)}

                <!-- Generate New Plan Button -->
                <div class="text-center mt-6">
                    <button onclick="location.reload()" 
                            class="bg-balanz-blue text-white font-semibold py-3 px-6 rounded-lg hover:bg-opacity-90 transition-colors">
                        üîÑ Generer ny madplan
                    </button>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
            placeholder.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            
            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function generateShoppingListHTML(shoppingList) {
            if (!shoppingList || Object.keys(shoppingList).length === 0) {
                return '<div class="mt-8 bg-white rounded-xl shadow-md p-6"><p class="text-gray-500">Ingen indk√∏bsliste tilg√¶ngelig</p></div>';
            }

            const storeNames = {
                'coop': 'Coop',
                'rema': 'REMA 1000',
                'rema 1000': 'REMA 1000',
                'lidl': 'Lidl',
                'netto': 'Netto',
                'foetex': 'F√∏tex',
                'f√∏tex': 'F√∏tex',
                'discount365': 'Discount365',
                'almindelig': 'Anden butik'
            };

            const storeColors = {
                'coop': 'blue-600',
                'rema': 'red-600',
                'rema 1000': 'red-600',
                'lidl': 'yellow-600',
                'netto': 'green-600',
                'foetex': 'purple-600',
                'f√∏tex': 'purple-600',
                'discount365': 'orange-600',
                'almindelig': 'gray-600'
            };

            let html = `
                <div class="mt-8 bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üõ™ Komplet Indk√∏bsguide</h3>
                        <button onclick="printShoppingList()" 
                                class="bg-balanz-green text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition-colors flex items-center space-x-2">
                            <span>üñ®Ô∏è</span>
                            <span>Print Liste</span>
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
            `;
            
            Object.entries(shoppingList).forEach(([storeKey, items]) => {
                if (!items || items.length === 0) return;
                
                const storeName = storeNames[storeKey.toLowerCase()] || storeKey;
                const colorClass = storeColors[storeKey.toLowerCase()] || 'gray-600';
                
                html += `
                    <div>
                        <h4 class="font-semibold text-${colorClass} mb-2">${storeName} (${items.length} varer)</h4>
                        <ul class="space-y-1">
                            ${items.map(item => `
                                <li class="flex justify-between text-sm">
                                    <span class="flex items-center">
                                        ${item.onSale ? '‚úÖ' : '‚ö´'} ${item.item || 'Ukendt vare'}
                                    </span>
                                    <span class="font-semibold">
                                        ${item.price ? (item.onSale ? `${Math.round(item.price)} kr` : `~${Math.round(item.price)} kr`) : 'Se pris'}
                                        <span class="text-xs text-gray-500 ml-1">
                                            ${item.onSale ? '(P√• tilbud)' : '(Est.)'}
                                        </span>
                                    </span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div class="mt-4 text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                        üí° <strong>Tips:</strong> Krydderier, salt, peber og olie antages at v√¶re hjemme allerede
                    </div>
                </div>
            `;
            
            return html;
        }

        function printShoppingList() {
            if (!currentMealPlanData) {
                alert('Ingen madplan data fundet. Generer venligst en madplan f√∏rst.');
                return;
            }

            // Store data for print page
            localStorage.setItem('currentMealPlan', JSON.stringify(currentMealPlanData));
            
            // Open print page
            window.open('/print-shopping-list.html', '_blank');
        }
    </script>
</body>
</html>